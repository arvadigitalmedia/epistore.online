name: Deploy to Development (cPanel)

on:
  push:
    branches: [ "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          # Definisikan Path PHP spesifik cPanel (sesuaikan dengan hosting)
          PHP_BIN="/usr/local/bin/php"
          # Atau cari path php 8.3, misal: /opt/cpanel/ea-php83/root/usr/bin/php
          
          # Masuk ke folder project
          cd ~/repositories/epi-oss-dev
          
          # Tarik kode terbaru
          git pull origin develop
          
          # Install dependensi (tanpa dev dependencies untuk hemat space/waktu)
          $PHP_BIN /usr/local/bin/composer install --no-interaction --prefer-dist --optimize-autoloader
          
          # Migrasi Database
          $PHP_BIN artisan migrate --force
          
          # Clear & Cache Config
          $PHP_BIN artisan optimize:clear
          $PHP_BIN artisan config:cache
          $PHP_BIN artisan route:cache
          $PHP_BIN artisan view:cache
          
          # Build Frontend Assets (Opsional: Jika server tidak support npm/node, build di runner github lalu upload via FTP/SCP)
          # Jika server support Node.js:
          # npm install && npm run build
